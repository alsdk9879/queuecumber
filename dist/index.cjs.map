{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import type {\n  IProgressInfo,\n  IQueuecumber,\n  IQueuecumberOptions,\n} from \"./types.js\";\n\n/**\n * 작업 큐 배치 처리 라이브러리\n * @remarks Promise 기반 작업을 배치 단위로 순차 실행하며, 에러 처리 및 진행 상황 추적 기능 제공\n */\nclass Queuecumber implements IQueuecumber {\n  /** 라이브러리 버전 정보 */\n  version = \"1.0.12\";\n\n  // ==================== Private Fields ====================\n\n  /** 대기 중인 작업 큐 */\n  private items: (() => Promise<any>)[] = [];\n\n  /** 에러 발생 시 중단 여부 */\n  private breakWhenError: boolean = false;\n\n  /** 한 번에 처리할 작업 수 */\n  private batchSize: number = 1;\n\n  /** 진행 상황 콜백 */\n  private onProgress?: (progress: IProgressInfo) => void;\n\n  /** 현재 배치의 완료된 작업 결과 배열 */\n  private completed: any[] = [];\n\n  /** 현재 실행 중인 배치의 작업 배열 */\n  private runningBatches: (() => Promise<any>)[] = [];\n\n  /** 실행 중인 슬롯 상태 배열 */\n  private runningSlots: boolean[] = [];\n\n  // ==================== Private Getters ====================\n\n  /**\n   * 남은 배치 수 계산\n   * @returns 처리해야 할 남은 배치 수\n   */\n  private get batchToProcess() {\n    return Math.ceil(this.items.length / this.batchSize);\n  }\n\n  /**\n   * 현재 배치 처리 완료 여부 확인 및 콜백 호출\n   * @returns 배치 처리가 완료되었는지 여부\n   * @remarks 배치 완료 시 onProgress 콜백 호출 후 상태 초기화\n   */\n  private get batchProcessFinished() {\n    let completedCount = Object.keys(this.completed).length;\n    let isFinished = completedCount === this.runningBatches.length;\n\n    if (isFinished) {\n      const completed = this.completed;\n\n      // 콜백 호출 전 상태 초기화\n      this.completed = [];\n      this.runningBatches = [];\n      this.runningSlots = [];\n\n      if (this.onProgress) {\n        this.onProgress({\n          batchToProcess: this.batchToProcess,\n          itemsToProcess: this.items.length,\n          completed: completed,\n        });\n      }\n    }\n\n    return isFinished;\n  }\n\n  // ==================== Constructor ====================\n\n  /**\n   * Queuecumber 인스턴스 생성\n   * @param option 큐 설정 옵션\n   * @throws {Error} batchSize가 1 미만인 경우\n   * @throws {Error} onProgress가 함수가 아닌 경우\n   */\n  constructor(option?: IQueuecumberOptions) {\n    this.breakWhenError = !!option?.breakWhenError;\n    this.batchSize = option?.batchSize ?? 1;\n\n    if (typeof this.batchSize !== \"number\" || this.batchSize < 1) {\n      throw new Error(\"batchSize must be at least 1\");\n    }\n\n    if (option?.onProgress) {\n      if (typeof option.onProgress === \"function\") {\n        this.onProgress = option.onProgress;\n      } else {\n        throw new Error(\"onProgress must be a function\");\n      }\n    }\n  }\n\n  // ==================== Public Methods ====================\n\n  /**\n   * 작업을 큐에 추가하고 처리 시작\n   * @param jobs Promise를 반환하는 함수 또는 함수 배열\n   * @throws {Error} 작업이 함수가 아닌 경우\n   * @remarks 작업을 큐에 추가한 후 즉시 processNext()를 호출하여 처리 시작\n   */\n  add(jobs: (() => Promise<any>)[] | (() => Promise<any>)) {\n    const jobsArray = Array.isArray(jobs) ? jobs : [jobs];\n\n    for (const job of jobsArray) {\n      if (typeof job !== \"function\") {\n        throw new Error(\"Each job must be a function that returns a Promise\");\n      }\n      this.items.push(job);\n    }\n\n    this.processNext();\n  }\n\n  /**\n   * 큐에 대기 중인 모든 작업 제거\n   * @remarks 현재 실행 중인 runningBatches의 작업은 중단하지 않고 계속 실행됨\n   */\n  terminate() {\n    this.items = [];\n  }\n\n  // ==================== Private Methods ====================\n\n  /**\n   * 다음 배치 작업 처리 시작\n   * @remarks 큐에서 batchSize만큼 작업을 꺼내 동시 실행\n   */\n  private processNext() {\n    if (this.items.length === 0) {\n      return;\n    }\n\n    const batchToRun = this.batchSize - this.runningBatches.length;\n    if (batchToRun <= 0) {\n      return;\n    }\n\n    this.runningBatches.push(...this.items.splice(0, batchToRun));\n\n    for (let i = 0; i < this.runningBatches.length; i++) {\n      if (this.runningSlots?.[i]) {\n        continue;\n      }\n\n      this.runningSlots[i] = true;\n      (this.runningBatches[i] as () => Promise<any>)()\n        .then((result) => {\n          if (this.completed[i]) {\n            return result;\n          }\n\n          this.completed[i] = result;\n\n          if (this.batchProcessFinished) {\n            return this.processNext();\n          }\n\n          return result;\n        })\n        .catch((err) => {\n          if (this.breakWhenError) {\n            throw err;\n          }\n\n          this.completed[i] = err;\n\n          if (this.batchProcessFinished) {\n            return this.processNext();\n          }\n\n          return err;\n        });\n    }\n  }\n}\n\nexport default Queuecumber;\nexport type { IQueuecumber, IQueuecumberOptions, IProgressInfo } from \"./types.js\";\n"],"names":["Queuecumber","isFinished","completed","option","jobs","jobsArray","job","batchToRun","i","result","err"],"mappings":"aAUA,MAAMA,CAAoC,CAExC,QAAU,SAKF,MAAgC,CAAA,EAGhC,eAA0B,GAG1B,UAAoB,EAGpB,WAGA,UAAmB,CAAA,EAGnB,eAAyC,CAAA,EAGzC,aAA0B,CAAA,EAQlC,IAAY,gBAAiB,CAC3B,OAAO,KAAK,KAAK,KAAK,MAAM,OAAS,KAAK,SAAS,CACrD,CAOA,IAAY,sBAAuB,CAEjC,IAAIC,EADiB,OAAO,KAAK,KAAK,SAAS,EAAE,SACb,KAAK,eAAe,OAExD,GAAIA,EAAY,CACd,MAAMC,EAAY,KAAK,UAGvB,KAAK,UAAY,CAAA,EACjB,KAAK,eAAiB,CAAA,EACtB,KAAK,aAAe,CAAA,EAEhB,KAAK,YACP,KAAK,WAAW,CACd,eAAgB,KAAK,eACrB,eAAgB,KAAK,MAAM,OAC3B,UAAAA,CAAA,CACD,CAEL,CAEA,OAAOD,CACT,CAUA,YAAYE,EAA8B,CAIxC,GAHA,KAAK,eAAiB,CAAC,CAACA,GAAQ,eAChC,KAAK,UAAYA,GAAQ,WAAa,EAElC,OAAO,KAAK,WAAc,UAAY,KAAK,UAAY,EACzD,MAAM,IAAI,MAAM,8BAA8B,EAGhD,GAAIA,GAAQ,WACV,GAAI,OAAOA,EAAO,YAAe,WAC/B,KAAK,WAAaA,EAAO,eAEzB,OAAM,IAAI,MAAM,+BAA+B,CAGrD,CAUA,IAAIC,EAAqD,CACvD,MAAMC,EAAY,MAAM,QAAQD,CAAI,EAAIA,EAAO,CAACA,CAAI,EAEpD,UAAWE,KAAOD,EAAW,CAC3B,GAAI,OAAOC,GAAQ,WACjB,MAAM,IAAI,MAAM,oDAAoD,EAEtE,KAAK,MAAM,KAAKA,CAAG,CACrB,CAEA,KAAK,YAAA,CACP,CAMA,WAAY,CACV,KAAK,MAAQ,CAAA,CACf,CAQQ,aAAc,CACpB,GAAI,KAAK,MAAM,SAAW,EACxB,OAGF,MAAMC,EAAa,KAAK,UAAY,KAAK,eAAe,OACxD,GAAI,EAAAA,GAAc,GAIlB,MAAK,eAAe,KAAK,GAAG,KAAK,MAAM,OAAO,EAAGA,CAAU,CAAC,EAE5D,QAASC,EAAI,EAAGA,EAAI,KAAK,eAAe,OAAQA,IAC1C,KAAK,eAAeA,CAAC,IAIzB,KAAK,aAAaA,CAAC,EAAI,GACtB,KAAK,eAAeA,CAAC,IACnB,KAAMC,GACD,KAAK,UAAUD,CAAC,EACXC,GAGT,KAAK,UAAUD,CAAC,EAAIC,EAEhB,KAAK,qBACA,KAAK,YAAA,EAGPA,EACR,EACA,MAAOC,GAAQ,CACd,GAAI,KAAK,eACP,MAAMA,EAKR,OAFA,KAAK,UAAUF,CAAC,EAAIE,EAEhB,KAAK,qBACA,KAAK,YAAA,EAGPA,CACT,CAAC,GAEP,CACF"}